<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>User Dashboard — Tinkling Tales</title>
        <link
            rel="icon"
            type="image/jpg"
            sizes="32x32"
            href="/tinklingtales_logo.jpg"
        />
        <link rel="apple-touch-icon" href="/tinklingtales_logo.jpg" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
        />

        <style>
            :root {
                --bg: #f7f7fb;
                --card: #ffffff;
                --text: #111827;
                --muted: #6b7280;
                --brand: #111111;
                --line: #e5e7eb;
                --radius: 18px;
                --shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
            }
            body {
                margin: 0;
                font-family: "Inter", sans-serif;
                background: var(--bg);
                color: var(--text);
            }
            a {
                color: inherit;
                text-decoration: none;
            }
            .container {
                max-width: 860px;
                margin: 0 auto;
                padding: 40px 16px;
            }
            header,
            footer {
                background: rgba(255, 255, 255, 0.8);
                border-bottom: 1px solid var(--line);
                backdrop-filter: blur(8px);
            }
            .h-row {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 10px;
            }
            .brand {
                font-weight: 800;
                font-size: 18px;
            }
            .spacer {
                flex: 1;
            }
            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 8px 12px;
                border-radius: 10px;
                border: 1px solid var(--line);
                background: #fff;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            }

            .btn:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
            }

            .btn:disabled,
            .btn.loading {
                opacity: 0.7;
                cursor: not-allowed;
                pointer-events: none;
            }

            .btn.loading::after {
                content: "";
                position: absolute;
                width: 14px;
                height: 14px;
                border: 2px solid transparent;
                border-top: 2px solid currentColor;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 6px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .btn.primary {
                background: var(--brand);
                color: #fff;
                border-color: var(--brand);
            }
            .card {
                background: var(--card);
                border: 1px solid var(--line);
                border-radius: var(--radius);
                padding: 20px;
                box-shadow: var(--shadow);
                margin-bottom: 20px;
            }
            .card h2 {
                margin: 0 0 12px;
                font-size: 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .avatar {
                width: 64px;
                height: 64px;
                border-radius: 50%;
                background: #e5e7eb;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                font-weight: 700;
                color: #555;
                margin-right: 16px;
                overflow: hidden;
            }
            .profile-row {
                display: flex;
                align-items: center;
            }
            .profile-name {
                font-size: 20px;
                font-weight: 700;
                margin: 0;
            }
            .profile-username {
                font-size: 14px;
                color: var(--muted);
                margin: 4px 0;
            }
            .profile-email {
                font-size: 14px;
                margin: 0;
            }
            .tag {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 600;
                margin-left: 6px;
            }
            .tag.red {
                background: #fee2e2;
                color: #b91c1c;
            }
            .tag.green {
                background: #dcfce7;
                color: #166534;
            }
            .order {
                border: 1px solid var(--line);
                border-radius: 12px;
                padding: 12px;
                margin-bottom: 12px;
                background: #fafafa;
            }
            .muted {
                color: var(--muted);
                font-size: 14px;
            }
            footer .row {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                align-items: center;
                justify-content: space-between;
                padding: 18px 0;
                color: #6b7280;
                font-size: 14px;
            }
            @media (max-width: 640px) {
                footer .row {
                    flex-direction: column;
                    text-align: center;
                    gap: 8px;
                }
            }
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
            }
            .modal-box {
                background: #fff;
                padding: 20px;
                border-radius: 12px;
                max-width: 500px;
                width: 90%;
            }

            /* Star Rating Styles */
            .star-rating {
                display: flex;
                gap: 4px;
                font-size: 24px;
                cursor: pointer;
            }

            .star {
                color: #ddd;
                transition: color 0.2s ease;
                cursor: pointer;
                user-select: none;
            }

            .star:hover,
            .star.active {
                color: #fbbf24;
            }

            .star.filled {
                color: #fbbf24;
            }

            .review-stars {
                display: flex;
                gap: 2px;
                font-size: 16px;
                margin-bottom: 8px;
            }

            .existing-review {
                margin-top: 12px;
                padding: 12px;
                background: #f9fafb;
                border-radius: 8px;
                border-left: 4px solid #fbbf24;
            }

            .review-text {
                margin: 0;
                font-style: italic;
                color: #374151;
            }

            /* Loading Animation */
            .loading-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                text-align: center;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f4f6;
                border-top: 4px solid #1f2937;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 16px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .loading-text {
                color: #6b7280;
                font-size: 16px;
                font-weight: 500;
            }
            .edit-icon {
                cursor: pointer;
                width: 18px;
                height: 18px;
                fill: #555;
            }

            /* Status colors */
            .status.pending {
                background: #fff;
                color: #555;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .status.confirmed {
                background: #fef9c3;
                color: #92400e;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .status.shipped {
                background: #bbf7d0;
                color: #166534;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .status.received {
                background: #86efac;
                color: #14532d;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .status.complete {
                background: #15803d;
                color: #fff;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .status.cancelled {
                background: #fee2e2;
                color: #991b1b;
                padding: 2px 6px;
                border-radius: 6px;
            }

            /* Timeline */
            .timeline {
                display: flex;
                justify-content: space-between;
                margin-top: 16px;
            }
            .step {
                flex: 1;
                text-align: center;
                padding: 8px;
                margin: 0 4px;
                border-radius: 6px;
                background: #e5e7eb;
                font-size: 13px;
                font-weight: 600;
                text-transform: capitalize;
            }
            .step.done {
                background: #bbf7d0;
                color: #166534;
            }
            .step.active {
                background: #facc15;
                color: #92400e;
            }
            .step.cancelled {
                background: #fee2e2;
                color: #991b1b;
            }

            header {
                position: sticky;
                top: 0;
                z-index: 40;
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(8px);
                border-bottom: 1px solid var(--line);
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header>
            <div class="container h-row">
                <div style="font-size: 18px" class="brand">
                    <a
                        href="/index.html"
                    >
                        Tinkling Tales
                    </a>
                </div>
                <span class="spacer"></span>

                <!-- Facebook -->
                <a
                    href="https://www.facebook.com/tinklingtales"
                    target="_blank"
                    aria-label="Facebook"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path
                            d="M22 12a10 10 0 1 0-11.5 9.9v-7h-2v-2.9h2V9.5c0-2 1.2-3.1 3-3.1.9 0 1.8.1 1.8.1v2h-1c-1 0-1.3.6-1.3 1.2v1.4h2.3L14 14.9h-1.8v7A10 10 0 0 0 22 12"
                        />
                    </svg>
                </a>

                <!-- Instagram -->
                <a
                    href="https://www.instagram.com/tinklingtales"
                    target="_blank"
                    aria-label="Instagram"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path
                            d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7zm0 2h10c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3zm5 2.8A5.2 5.2 0 1 0 17.2 12 5.2 5.2 0 0 0 12 6.8zm0 2A3.2 3.2 0 1 1 8.8 12 3.2 3.2 0 0 1 12 8.8zM17.5 6a1 1 0 1 0 1 1 1 1 0 0 0-1-1z"
                        />
                    </svg>
                </a>

                <!-- Logout -->
                <a id="logoutBtn" href="javascript:void(0)" aria-label="Logout">
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path
                            d="M16 13v-2H7V8l-5 4 5 4v-3h9zm3-10H9c-1.1 0-2 .9-2 2v4h2V5h10v14H9v-4H7v4c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"
                        />
                    </svg>
                </a>
            </div>
        </header>

        <!-- Main -->
        <main class="container">
            <!-- Profile -->
            <div class="card" id="profileCard">
                <div class="profile-row">
                    <div class="avatar" id="avatar"></div>
                    <div>
                        <p class="profile-name" id="fullName"></p>
                        <p class="profile-username" id="userMeta"></p>
                        <p class="profile-email">
                            <span id="email"></span>
                            <span id="emailStatus"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="card">
                <h2>
                    Contact Information
                    <svg
                        id="editContact"
                        xmlns="http://www.w3.org/2000/svg"
                        class="edit-icon"
                        viewBox="0 0 20 20"
                    >
                        <path
                            d="M17.414 2.586a2 2 0 0 0-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 0 0 0-2.828zM4 15h12v2H4v-2z"
                        />
                    </svg>
                </h2>
                <p><strong>Phone:</strong> <span id="phone"></span></p>
                <p><strong>Address:</strong> <span id="address"></span></p>

                <!-- 🔹 Delete Account button -->
                <button
                    id="deleteAccountBtn"
                    class="btn"
                    style="
                        margin-top: 12px;
                        background: #fee2e2;
                        color: #991b1b;
                    "
                >
                    Delete Account
                </button>
            </div>

            <!-- Orders -->
            <div class="card">
                <h2>Purchase History</h2>
                <div id="orders"></div>
            </div>
        </main>

        <!-- Footer -->
        <footer>
            <div class="container row" style="max-width: 1160px">
                <div>
                    © <span id="year"></span> Tinkling Tales. All rights
                    reserved.
                </div>
                <div style="display: flex; gap: 12px">
                    <a class="muted" href="/return-policy.html"
                        >Return Policy</a
                    >
                    <a class="muted" href="/terms.html">Terms</a>
                    <a class="muted" href="/contact.html">Contact</a>
                </div>
            </div>
        </footer>

        <!-- Modal for verification -->
        <div class="modal" id="verifyModal">
            <div class="modal-box">
                <h3>Email Verification</h3>
                <p>Enter the 6-digit code sent to your email:</p>
                <input
                    type="text"
                    id="verifyCode"
                    maxlength="6"
                    style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                    "
                />
                <div style="margin-top: 12px; text-align: right">
                    <button class="btn" id="closeVerify">Cancel</button>
                    <button class="btn primary" id="submitVerify">
                        Verify
                    </button>
                </div>
            </div>
        </div>

        <!-- Order Timeline Modal -->
        <div class="modal" id="orderModal">
            <div class="modal-box">
                <h3>Order Details</h3>
                <div id="orderDetails"></div>
                <div id="statusTimeline" style="margin-top: 16px"></div>
                <div style="margin-top: 12px; text-align: right">
                    <button class="btn" id="closeOrder">Close</button>
                </div>
            </div>
        </div>

        <!-- Review Modal -->
        <div class="modal" id="reviewModal">
            <div class="modal-box">
                <h3>Leave a Review</h3>
                <div id="reviewOrderDetails" style="margin-bottom: 16px;"></div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rating:</label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">☆</span>
                        <span class="star" data-rating="2">☆</span>
                        <span class="star" data-rating="3">☆</span>
                        <span class="star" data-rating="4">☆</span>
                        <span class="star" data-rating="5">☆</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Review:</label>
                    <textarea 
                        id="reviewText" 
                        placeholder="Share your experience with this product..."
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical; min-height: 80px;">
                    </textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" id="closeReview">Cancel</button>
                    <button class="btn primary" id="submitReview">Submit Review</button>
                </div>
            </div>
        </div>

        <script>
                document.getElementById("year").textContent = new Date().getFullYear();

                const API_URL = "https://script.google.com/macros/s/AKfycbyMQRrvsac_lBvYOlt5gtaO4CKHTea7_UjeUC2VluTrPCKaYOERrpXV5jhkgoJPnYzdPA/exec";
                async function apiRequest(payload) {
                  const res = await fetch(API_URL, { method:"POST", body: JSON.stringify(payload) });
                  return res.json();
                }

                // ===== LOADING STATE HELPER =====
                function setButtonLoading(button, isLoading, originalText = null) {
                    if (isLoading) {
                        button.disabled = true;
                        button.classList.add('loading');
                        if (originalText) {
                            button.dataset.originalText = button.textContent;
                            button.textContent = originalText;
                        }
                    } else {
                        button.disabled = false;
                        button.classList.remove('loading');
                        if (button.dataset.originalText) {
                            button.textContent = button.dataset.originalText;
                            delete button.dataset.originalText;
                        }
                    }
                }

                let user = JSON.parse(localStorage.getItem("user") || "{}");
                if (!user.userId) window.location.href = "login.html";

                // Profile
                document.getElementById("fullName").textContent = user.fullName;
                document.getElementById("userMeta").textContent = `(@${user.username}) • UserID: ${user.userId}`;
                document.getElementById("email").textContent = user.email;

                if (user.picture) {
                  document.getElementById("avatar").innerHTML =
                    `<img src="${user.picture}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`;
                } else {
                  document.getElementById("avatar").textContent =
                    user.fullName ? user.fullName.charAt(0).toUpperCase() : "?";
                }

                const emailTag = document.getElementById("emailStatus");
                if (user.emailVerify === "verified") {
                  emailTag.innerHTML = `<span class="tag green">Verified</span>`;
                } else {
                  emailTag.innerHTML = `<span class="tag red" id="openVerify">Unverified</span>`;
                  document.getElementById("openVerify").addEventListener("click", () => {
                    document.getElementById("verifyModal").style.display = "flex";
                  });
                }

                // Contact
                document.getElementById("phone").textContent = user.phone || "-";
                document.getElementById("address").textContent = user.address || "-";
                document.getElementById("editContact").addEventListener("click", async () => {
                  const newPhone = prompt("Enter new phone:", user.phone || "");
                  const newAddr = prompt("Enter new address:", user.address || "");
                  if (newPhone || newAddr) {
                    const editBtn = document.getElementById("editContact");
                    setButtonLoading(editBtn, true, "Updating...");
                    
                    try {
                      await apiRequest({ action:"updateUser", userId:user.userId, phone:newPhone, address:newAddr });
                      user.phone = newPhone;
                      user.address = newAddr;
                      localStorage.setItem("user", JSON.stringify(user));
                      document.getElementById("phone").textContent = newPhone;
                      document.getElementById("address").textContent = newAddr;
                    } catch (error) {
                      alert("Failed to update contact information. Please try again.");
                    } finally {
                      setButtonLoading(editBtn, false);
                    }
                  }
                });

                // Delete Account
                document.getElementById("deleteAccountBtn").addEventListener("click", async () => {
                  if (!confirm("⚠️ Are you sure? This will permanently delete your account and all orders.")) return;

                  const confirmText = prompt("Type DELETE to confirm account deletion:");
                  if (confirmText !== "DELETE") {
                    alert("Account deletion cancelled.");
                    return;
                  }

                  const deleteBtn = document.getElementById("deleteAccountBtn");
                  setButtonLoading(deleteBtn, true, "Deleting...");

                  try {
                    const res = await apiRequest({ action:"deleteAccount", userId:user.userId });
                    if (res.success) {
                      alert("Your account and all orders have been deleted.");
                      localStorage.removeItem("user");
                      window.location.href = "login.html";
                    } else {
                      alert(res.error || "Failed to delete account.");
                    }
                  } catch (error) {
                    alert("Network error. Please check your connection and try again.");
                  } finally {
                    setButtonLoading(deleteBtn, false);
                  }
                });

                // Orders (with Show More + timeline)
                function statusClass(status) {
                  switch (status.toLowerCase()) {
                    case "pending": return "status pending";
                    case "confirmed": return "status confirmed";
                    case "shipped": return "status shipped";
                    case "received": return "status received";
                    case "complete": return "status complete";
                    case "cancelled": return "status cancelled";
                    default: return "status";
                  }
                }
                
                function formatDate(dateStr) {
                    const d = new Date(dateStr);
                    const day = String(d.getDate()).padStart(2, '0');
                    const month = String(d.getMonth() + 1).padStart(2, '0'); // months are 0-based
                    const year = d.getFullYear();
                    const hours = String(d.getHours()).padStart(2, '0');
                    const minutes = String(d.getMinutes()).padStart(2, '0');
                    const seconds = String(d.getSeconds()).padStart(2, '0');
                    
                    return `${day}-${month}-${year}, ${hours}:${minutes}:${seconds}`;
                }

                let allOrders = [];
                let visibleCount = 6;

                async function loadOrders(initial = true) {
                  const ordersDiv = document.getElementById("orders");
                  
                  if (initial) {
                    // Show loading animation
                    ordersDiv.innerHTML = `
                      <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading your purchase history...</div>
                      </div>
                    `;
                    
                    try {
                      const res = await apiRequest({ action:"getOrders", userId:user.userId });
                      allOrders = res || [];
                      visibleCount = 6;
                    } catch (error) {
                      ordersDiv.innerHTML = `
                        <div class="loading-container">
                          <div class="loading-text" style="color: #ef4444;">Failed to load orders. Please try again.</div>
                        </div>
                      `;
                      return;
                    }
                  }

                  ordersDiv.innerHTML = "";

                  if (!allOrders.length) {
                    ordersDiv.innerHTML = `<p class="muted">No past deliveries</p>`;
                    return;
                  }

                  const toShow = allOrders.slice(0, visibleCount);
                  toShow.forEach(o => {
                    const div = document.createElement("div");
                    div.className = "order";
                    div.innerHTML = `
                      <p><strong>Order #${o.orderId}</strong></p>
                      <p>${o.details}</p>
                      <p>Total: ${o.total}</p>
                      <p>Status: <span class="${statusClass(o.status)}">${o.status}</span></p>
                      <p class="muted">${formatDate(o.dateTime)}</p>
                    `;

                    const viewBtn = document.createElement("button");
                    viewBtn.className = "btn";
                    viewBtn.textContent = "View Details";
                    viewBtn.style.marginRight = "12px";
                    viewBtn.addEventListener("click", () => viewOrder(o));
                    div.appendChild(viewBtn);

                    if (o.status === "pending") {
                      const cancelBtn = document.createElement("button");
                      cancelBtn.className = "btn";
                      cancelBtn.textContent = "Cancel";
                      cancelBtn.addEventListener("click", () => cancelOrder(o.orderId, cancelBtn));
                      div.appendChild(cancelBtn);
                    } else if (o.status === "complete") {
                      // Check if review already exists
                      if (!o.review) {
                        const reviewBtn = document.createElement("button");
                        reviewBtn.className = "btn primary";
                        reviewBtn.textContent = "Leave Review";
                        reviewBtn.addEventListener("click", () => openReviewModal(o));
                        div.appendChild(reviewBtn);
                      } else {
                        // Show existing review
                        const reviewDiv = document.createElement("div");
                        reviewDiv.className = "existing-review";
                        reviewDiv.innerHTML = `
                          <div class="review-stars">${generateStars(o.review.rating, true)}</div>
                          <p class="review-text">"${o.review.text}"</p>
                        `;
                        div.appendChild(reviewDiv);
                      }
                    }

                    ordersDiv.appendChild(div);
                  });

                  if (visibleCount < allOrders.length) {
                    const showMoreBtn = document.createElement("button");
                    showMoreBtn.className = "btn";
                    showMoreBtn.textContent = "Show More";
                    showMoreBtn.style.marginTop = "10px";
                    showMoreBtn.addEventListener("click", () => {
                      visibleCount += 6;
                      loadOrders(false);
                    });
                    ordersDiv.appendChild(showMoreBtn);
                  }
                }

                async function cancelOrder(orderId, cancelBtn) {
                  if (!confirm("Cancel this order?")) return;
                  
                  setButtonLoading(cancelBtn, true, "Cancelling...");
                  
                  try {
                    await apiRequest({ action:"updateOrder", orderId: orderId.toString(), status:"cancelled" });
                    loadOrders(true);
                  } catch (error) {
                    alert("Failed to cancel order. Please try again.");
                    setButtonLoading(cancelBtn, false);
                  }
                }

                function viewOrder(order) {
                  const detailsDiv = document.getElementById("orderDetails");
                  detailsDiv.innerHTML = `
                    <p><strong>Order ID:</strong> ${order.orderId}</p>
                    <p><strong>Details:</strong> ${order.details}</p>
                    <p><strong>Total:</strong> ${order.total}</p>
                    <p><strong>Address:</strong> ${order.address}</p>
                  `;

                  const steps = ["pending", "confirmed", "shipped", "received", "complete"];
                  let timeline = "";
                  steps.forEach(step => {
                    let cls = "step";
                    if (order.status.toLowerCase() === step) cls += " active";
                    if (steps.indexOf(step) < steps.indexOf(order.status.toLowerCase())) cls += " done";
                    if (order.status.toLowerCase() === "cancelled" && step === "pending") cls += " cancelled";
                    timeline += `<div class="${cls}">${step}</div>`;
                  });
                  if (order.status.toLowerCase() === "cancelled") {
                    timeline = `<div class="step cancelled active">Cancelled</div>`;
                  }

                  document.getElementById("statusTimeline").innerHTML = `<div class="timeline">${timeline}</div>`;
                  document.getElementById("orderModal").style.display = "flex";
                }

                document.getElementById("closeOrder").addEventListener("click", () => {
                  document.getElementById("orderModal").style.display = "none";
                });

                // ===== REVIEW SYSTEM =====
                let currentReviewOrder = null;
                let selectedRating = 0;

                function generateStars(rating, readonly = false) {
                  let stars = "";
                  for (let i = 1; i <= 5; i++) {
                    if (i <= rating) {
                      stars += "★"; // Filled star
                    } else {
                      stars += "☆"; // Empty star
                    }
                  }
                  return `<span style="color: #fbbf24;">${stars}</span>`;
                }

                function openReviewModal(order) {
                  currentReviewOrder = order;
                  selectedRating = 0;
                  
                  // Reset form
                  document.getElementById("reviewText").value = "";
                  resetStarRating();
                  
                  // Show order details
                  document.getElementById("reviewOrderDetails").innerHTML = `
                    <div style="padding: 12px; background: #f3f4f6; border-radius: 8px;">
                      <p><strong>Order #${order.orderId}</strong></p>
                      <p>${order.details}</p>
                    </div>
                  `;
                  
                  document.getElementById("reviewModal").style.display = "flex";
                }

                function resetStarRating() {
                  const stars = document.querySelectorAll("#starRating .star");
                  stars.forEach(star => {
                    star.classList.remove("filled", "active");
                    star.textContent = "☆";
                  });
                }

                function updateStarRating(rating) {
                  const stars = document.querySelectorAll("#starRating .star");
                  stars.forEach((star, index) => {
                    if (index < rating) {
                      star.classList.add("filled");
                      star.textContent = "★";
                    } else {
                      star.classList.remove("filled");
                      star.textContent = "☆";
                    }
                  });
                }

                // Star rating event listeners
                document.querySelectorAll("#starRating .star").forEach(star => {
                  star.addEventListener("click", () => {
                    selectedRating = parseInt(star.dataset.rating);
                    updateStarRating(selectedRating);
                  });
                  
                  star.addEventListener("mouseover", () => {
                    const rating = parseInt(star.dataset.rating);
                    updateStarRating(rating);
                  });
                });

                document.getElementById("starRating").addEventListener("mouseleave", () => {
                  updateStarRating(selectedRating);
                });

                // Review modal event listeners
                document.getElementById("closeReview").addEventListener("click", () => {
                  document.getElementById("reviewModal").style.display = "none";
                });

                document.getElementById("submitReview").addEventListener("click", async () => {
                  if (selectedRating === 0) {
                    alert("Please select a rating!");
                    return;
                  }
                  
                  const reviewText = document.getElementById("reviewText").value.trim();
                  if (!reviewText) {
                    alert("Please write a review!");
                    return;
                  }
                  
                  const submitBtn = document.getElementById("submitReview");
                  setButtonLoading(submitBtn, true, "Submitting...");
                  
                  try {
                    const reviewData = {
                      action: "addReview",
                      orderId: currentReviewOrder.orderId,
                      userId: user.userId,
                      rating: selectedRating,
                      text: reviewText,
                      dateTime: new Date().toISOString()
                    };
                    
                    const res = await apiRequest(reviewData);
                    if (res.success) {
                      // Update the order locally to include the review
                      const orderIndex = allOrders.findIndex(o => o.orderId === currentReviewOrder.orderId);
                      if (orderIndex !== -1) {
                        allOrders[orderIndex].review = {
                          rating: selectedRating,
                          text: reviewText
                        };
                      }
                      
                      alert("Thank you for your review!");
                      document.getElementById("reviewModal").style.display = "none";
                      loadOrders(false); // Refresh the orders display
                    } else {
                      alert(res.error || "Failed to submit review. Please try again.");
                    }
                  } catch (error) {
                    alert("Network error. Please check your connection and try again.");
                  } finally {
                    setButtonLoading(submitBtn, false);
                  }
                });

                // Expose review functions to global scope for inline event handlers
                window.openReviewModal = openReviewModal;
                window.generateStars = generateStars;

                // Verify email
                document.getElementById("closeVerify").addEventListener("click", () => {
                  document.getElementById("verifyModal").style.display = "none";
                });
                document.getElementById("submitVerify").addEventListener("click", async () => {
                  const code = document.getElementById("verifyCode").value.trim();
                  if (!code) return alert("Enter code");
                  const res = await apiRequest({ action:"verifyEmail", userId:user.userId, code });
                  if (res.success) {
                    alert("Email verified!");
                    user.emailVerify = "verified";
                    localStorage.setItem("user", JSON.stringify(user));
                    window.location.reload();
                  } else {
                    alert(res.error || "Verification failed");
                  }
                });

                // Logout
            document.getElementById("logoutBtn").addEventListener("click", () => {
              localStorage.removeItem("user");
              window.location.href = "login.html";
            });

            // Load orders on page load
            loadOrders(true);
        </script>
    </body>
</html>